version: 1.0.{build}
image: Visual Studio 2017
configuration: Release
init:
  - SET PGUSER=postgres
  - SET PGPASSWORD=Password12!
  - PATH=C:\Program Files\PostgreSQL\9.6\bin\;%PATH%
install:
  - msbuild /t:restore ./csharp/Mejram.sln
before_build:
  - git submodule update --init --recursive
  - psql -c "CREATE DATABASE sakila;" -U postgres
  - psql -c "CREATE USER test WITH PASSWORD 'test';" -U postgres
  - psql -c "GRANT ALL PRIVILEGES ON DATABASE sakila to test" -U postgres
  - psql -d sakila -a -f ./pagila/pagila-schema.sql  -U postgres
  - psql -d sakila -a -f ./pagila/pagila-insert-data.sql  -U postgres
  - psql -d sakila -c "alter schema public owner to test" -U postgres
test_script:
  - dotnet test ./csharp/Tests
build:
  project: ./csharp/Mejram.sln
  verbosity: minimal
  publish_nuget: true
nuget:
  account_feed: false
  project_feed: true
  disable_publish_on_pr: true
services:
  - postgresql
branches:
  only:
    - master
